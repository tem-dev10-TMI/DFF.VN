# 02_wallet_security — Bảo mật ví Crypto cho cửa hàng & khách hàng (Chi tiết cho KB chatbot)

Mục tiêu: Cung cấp tài liệu tri thức chi tiết để chatbot và đội ngũ vận hành tham chiếu khi trả lời/triển khai chính sách bảo mật ví và xử lý gian lận trong thanh toán crypto.

========================================================================
0. Ghi chú chung
- File này bao gồm: nguyên tắc bảo mật, phân loại gian lận, mô tả cách thực hiện gian lận phổ biến, dấu hiệu cảnh báo, biện pháp phòng ngừa (kỹ thuật & quy trình), checklist vận hành, playbook xử lý sự cố, mẫu trả lời chatbot, và đề xuất công cụ giám sát.
- Áp dụng cho cả: wallet của cửa hàng (merchant wallets), hệ thống tạo invoice, webhook handler, và hướng dẫn khách hàng.

========================================================================
1. Nguyên tắc bảo mật & quản trị ví
- Phân tách trách nhiệm:
  + Ví nhận thanh toán (Hot wallet): chỉ giữ lượng nhỏ đủ cho thanh toán/ngày.
  + Ví lưu trữ (Cold wallet): lưu trữ phần lớn tài sản, offline (hardware wallet / air-gapped).
  + Ví trung gian (Settlement wallet): nếu cần convert/settle tự động.
- Quản lý secret:
  + Không lưu private keys/seed phrases trên cloud, chụp ảnh, email, chat.
  + Seed phrase viết tay, lưu két sắt/khóa, hoặc lưu bằng thiết bị bảo mật chuyên dụng (HSM) theo policy.
  + Quy trình backup offline (BIP39 passphrase lưu riêng).
- Quyền truy cập:
  + Least privilege: phân quyền API keys, chỉ cấp quyền cần thiết.
  + Rotated keys: thay đổi API keys/secret periódicamente (ví dụ 90 ngày) và revoke khi nghi ngờ.
  + Multi-sig cho cold wallets: require M-of-N approval cho rút lớn.
- Bảo vệ tài khoản phụ trợ:
  + Bật 2FA (authenticator app) cho email, exchange, console quản trị.
  + Không dùng SMS 2FA cho tài khoản quan trọng (vulnerable to SIM swap).
- Hệ thống audit & logging:
  + Log chi tiết mọi thao tác tạo invoice, ký chuyển tiền, webhook nhận, thao tác admin.
  + Lưu log bất biến (append only) hoặc replicate vào S3/stack khác.
- Môi trường vận hành:
  + Hardening server, firewall, network segmentation, chỉ mở port tối thiểu.
  + Monitor file integrity và bất thường (fail2ban, IDS/IPS).

========================================================================
2. Phân loại gian lận (overview)
- Phishing / Domain impersonation
- Social engineering / Support scam
- QR code tampering / Address tampering
- Invoice manipulation / Checkout hijacking
- Fake txid / tx spoofing / tx id reuse
- SIM swap / Account takeover
- Rug pull / Fake token deposit
- Double spend / RBF / Chain reorganizations
- Refund fraud (phony refund requests)
- Man-in-the-middle (MITM) / DNS hijacking
- Insider threat (nhân viên nội bộ làm trái)

Mỗi loại ở mục dưới có: cách thực hiện, dấu hiệu, biện pháp phòng ngừa, hành động khi phát hiện.

========================================================================
3. Chi tiết từng kiểu gian lận, cách thực hiện & phòng ngừa

3.1 Phishing / Domain impersonation
- Cách thực hiện:
  + Kẻ xấu tạo website hoặc email giống hệt domain shop (typosquatting), gửi link invoice giả, hoặc pop-up fake yêu cầu gửi tiền vào ví khác.
- Dấu hiệu:
  + Domain lạ, URL có ký tự thừa (e.g. sh0p-example.com), chứng chỉ SSL không hợp lệ, email từ tên miền khác.
- Phòng ngừa:
  + Sử dụng HSTS, TLS, CSP; đặt strict-transport security.
  + Email: SPF/DKIM/DMARC để giảm giả mạo.
  + Công khai địa chỉ ví trên trang HTTPS; QR code gốc được ký số (digital signature) nếu có thể.
  + Educate khách: chỉ dùng link thanh toán từ trang chính thức.
- Khi phát hiện:
  + Gỡ bỏ / báo cáo domain giả, thông báo khách hàng, check logs và tăng alert.

3.2 Support scam / Social engineering (Customer or Merchant)
- Cách thực hiện:
  + Kẻ xấu giả danh support, yêu cầu khách chuyển tiền vào địa chỉ khác, hoặc lừa admin chuyển tiền (qua điện thoại/email).
- Dấu hiệu:
  + Yêu cầu khẩn cấp, pressure, yêu cầu private key/seed, yêu cầu chuyển tiền ngay.
- Phòng ngừa:
  + Chính sách support: support KHÔNG bao giờ yêu cầu private key/seed.
  + Kịch bản xác thực caller: code OTP, hỏi thông tin bảo mật, xác minh email/ticket id.
  + Ghi âm cuộc gọi, logging support interactions.
- Khi phát hiện:
  + Ngắt liên hệ, xác minh ID support, báo cáo sự cố, thông báo khách.

3.3 QR code tampering / Address tampering
- Cách thực hiện:
  + Thay đổi QR hiển thị trên trang bằng script, inject JS, hoặc thay QR trên POS vật lý.
- Dấu hiệu:
  + Địa chỉ hiển thị không trùng với address trong DB/invoice, checksum mismatch, URL chứa script lạ.
- Phòng ngừa:
  + Generate address server-side; ký QR/URI bằng server key; validate address trước khi hiển thị.
  + Content Security Policy (CSP) để chặn inline script/xss.
  + Giao diện hiển thị địa chỉ dạng text + copy button (người dùng có thể kiểm tra).
- Khi phát hiện:
  + Tắt phần thanh toán crypto, kiểm tra integrity, restore từ backup, thông báo khách.

3.4 Invoice manipulation / Checkout hijacking
- Cách thực hiện:
  + Kẻ xấu inject JS (XSS) hoặc thay đổi hành trình checkout, redirect thanh toán đến địa chỉ của họ.
- Dấu hiệu:
  + Invoice_id không khớp order_id, amount crypto khác, IP/người agent lạ tạo invoice.
- Phòng ngừa:
  + Sanitize inputs, use parameterized queries, CSP, WAF, code review.
  + Verify server-side that invoice created corresponds đúng order_id và metadata.
  + Use signed tokens for invoice URLs (HMAC) with expiry.
- Khi phát hiện:
  + Invalidate invoices, notify affected users, forensic logs.

3.5 Fake txid / tx spoofing / tx id reuse
- Cách thực hiện:
  + Khách cung cấp txid giả (kẻ xấu copy txid trên chain khác hoặc create fake screenshot) để yêu cầu ship hàng trước khi tx confirm.
- Dấu hiệu:
  + Txid không tồn tại trên explorer; amount mismatch; confirmations = 0.
- Phòng ngừa:
  + Luôn verify txid trên blockchain explorer / node (RPC) và validate amount + destination address.
  + Thiết lập policy: require N confirmations based on tier.
- Khi phát hiện:
  + Từ chối xử lý; yêu cầu thông tin chứng thực; log và có thể báo cho cơ quan nếu lừa đảo hệ thống.

3.6 SIM swap / Account takeover
- Cách thực hiện:
  + Kẻ xấu chiếm SIM để nhận OTP, truy cập email, sàn, admin console.
- Dấu hiệu:
  + Nhiều đăng nhập từ location/IP lạ; thay đổi 2FA; yêu cầu thay đổi payout.
- Phòng ngừa:
  + Không dùng SMS OTP cho critical actions; ưu tiên app-based 2FA; Cảnh báo khi có change of 2FA/SMS.
  + Yêu cầu cooling-period / approval workflow cho thay đổi tài khoản.
- Khi phát hiện:
  + Revoke sessions, require manual KYC, freeze withdraws.

3.7 Rug pull / Fake token deposit
- Cách thực hiện:
  + Khách gửi token không có thanh khoản (mã token mới) hoặc token có fee trap; merchant chấp nhận dẫn đến khó swap.
- Dấu hiệu:
  + Token mới, contract unverified, liquidity pool nhỏ, token name mismatch.
- Phòng ngừa:
  + Whitelist tokens được phép; chỉ chấp nhận tokens phổ biến và có liquidity; monitor token contracts.
- Khi phát hiện:
  + Reject token, yêu cầu refund bằng fiat hoặc request khách chuyển token khác.

3.8 Double spend / RBF / Chain reorganizations
- Cách thực hiện:
  + Attacker dùng Replace-By-Fee để thay thế tx ban đầu; double spend attempt.
- Dấu hiệu:
  + Tx replaced in mempool, confirmations fluctuate, conflicting tx to same UTXO.
- Phòng ngừa:
  + Tăng số confirmations cho giá trị lớn; sử dụng watchtower / full node để detect double spend; policy delay for high-value orders.
- Khi phát hiện:
  + Mark tx suspicious; hold order until finality; notify security.

3.9 Refund fraud (claiming refund after sending fake txid)
- Cách thực hiện:
  + Người mua claim không nhận hàng và đòi refund dù chưa thanh toán thật.
- Dấu hiệu:
  + Không có txid hợp lệ; discrepancies trong logs; multiple refund requests from same account.
- Phòng ngừa:
  + Quy trình xác minh: check tx on-chain, KYC nếu > threshold, require evidence (screenshot, txid).
  + Retention policy: chứng minh đã giao, tracking vận chuyển.
- Khi phát hiện:
  + Yêu cầu khách cung cấp txid; hold refund; escalate to fraud team.

3.10 Man-in-the-middle (DNS hijack / MITM)
- Cách thực hiện:
  + Thay đổi DNS để redirect traffic tới server giả; can intercept invoice.
- Dấu hiệu:
  + Certificate mismatch, sudden traffic pattern changes, alerts from monitoring.
- Phòng ngừa:
  + Use DNSSEC, monitor DNS records, set up certificate transparency, alert on sudden DNS change.
- Khi phát hiện:
  + Switch to backup domain, notify users, investigate DNS registrar.

3.11 Insider threat
- Cách thực hiện:
  + Nhân viên nội bộ rút tiền, leak seed phrase, tạo invoice giả.
- Dấu hiệu:
  + Activity outside business hours, unusual tx, admin actions not logged properly.
- Phòng ngừa:
  + Role-based access control, audit trails, separation of duties, mandatory vacations, background checks.
- Khi phát hiện:
  + Revoke access, forensic investigation, involve HR/legal.

========================================================================
4. Biện pháp phòng ngừa kỹ thuật (Technical controls)
- Node & validator:
  + Chạy full node cho các chain chính (BTC, ETH, TRON) để verify tx trực tiếp.
- Verify on-chain:
  + Luôn kiểm tra txid trên node/explorer, verify `to address`, `amount`, `token contract`.
- Web security:
  + Use CSP, XSS protection, sanitize inputs, WAF, regular vulnerability scans.
- Webhook security:
  + HMAC signatures, timestamp + nonce, replay window, IP allowlist.
- Invoice integrity:
  + Sign invoice payloads (HMAC) and verify at frontend/back.
- Multi-sig & approvals:
  + Require M-of-N signatures cho withdrawals > threshold.
- Rate limiting & anomaly detection:
  + Rate limit invoice creation per IP/user; anomaly scoring for unusual patterns.

========================================================================
5. Biện pháp phòng ngừa quy trình (Operational controls)
- KYC & thresholds:
  + < X USD: xử lý bình thường; >= X USD: require merchant KYC and customer KYC.
- Human approval flow:
  + Withdrawals/settlements lớn cần 2 người/3 mắt nhìn (dual control).
- Cooling period:
  + Với withdraws to new address: delayed release (ví dụ 24–72 giờ) để detect takeover.
- Incident response plan:
  + Define escalation path, contacts, freeze procedures.
- Training:
  + Tập huấn nhân viên support: nhận diện social engineering & phishing.
- Customer education:
  + Hướng dẫn thanh toán an toàn, cảnh báo QR lạ, không chia sẻ seed.

========================================================================
6. Playbook xử lý sự cố (Incident Response)
Steps — Immediate (0–2 giờ)
1. Isolate: khóa chức năng rút tiền / tạm dừng xử lý crypto nếu nghi ngờ.
2. Revoke keys: rotate/revoke API keys bị nghi ngờ.
3. Snapshot logs: export logs, webhook payloads, DB snapshot, node mempool state.
4. Communicate internally: mở channel incident, assign owner.

Investigation (2–24 giờ)
5. Forensic: kiểm tra logs, IP, user agent, compare invoice_id & txid on chain.
6. Verify funds: check addresses đã nhận, số dư.
7. Contact providers: exchange/custodial provider support, node operators.

Containment & Recovery (24–72 giờ)
8. If funds stolen: prepare report (addresses, txids) to law enforcement, exchange watchlists.
9. Restore systems from clean backups, audit and patch vulnerabilities.
10. Post-mortem: lessons learned, update playbooks & training.

Communication
- External: thông báo khách hàng bị ảnh hưởng, hướng dẫn tiếp theo.
- Internal: report to management, legal, and compliance.

========================================================================
7. Logging, monitoring & alerting (what to collect)
- Events to log:
  + invoice created/updated/cancelled
  + webhook received (raw payload)
  + tx verified on-chain
  + admin actions (key rotation, withdraw)
  + failed signature verifications
- Metrics/alerts:
  + sudden spike expired invoices
  + webhook failures > threshold
  + new withdrawal to unknown address
  + mismatch between invoice address and displayed address
- Tools:
  + ELK/Graylog/Datadog/Prometheus + alerting; blockchain watchers (Blocknative, Alchemy Notify) or self node watchers.

========================================================================
8. Mẫu chính sách hoàn tiền (chi tiết)
- Nguyên tắc:
  + Refund trả về cùng chain/token.
  + Khách phải cung cấp txid gốc để xác minh.
  + Phí mạng trừ vào refund hoặc merchant chịu (nêu rõ).
- Quy trình:
  1. Khách gửi request + txid + bằng chứng KYC nếu > threshold.
  2. Verify tx exists and matches order (amount & destination).
  3. If valid → create refund tx (multi-sig approval if > limit).
  4. Log refund txid, notify customer.
  5. If invalid → từ chối, cung cấp hướng dẫn kháng nghị.
- Tình huống đặc biệt:
  + Nếu khách gửi trên chain sai (ví dụ: gửi USDT-ERC20 vào địa chỉ TRC20), refund có thể không khả thi — thông báo rõ rủi ro.

========================================================================
9. Mẫu trả lời chatbot (mở rộng, chuyên nghiệp)
- “Shop lưu ví như thế nào? Có an toàn không?”
  → “Shop áp dụng phân tách ví: ví nhận thanh toán (hot wallet) để xử lý đơn, và ví lạnh (Ledger/Trezor/multi-sig) để lưu trữ dài hạn. Mọi rút lớn đều yêu cầu phê duyệt nhiều bước. Bạn muốn biết cụ thể quy trình bảo mật của shop hay cách tự bảo vệ ví cá nhân?”
- “Tôi nhận được QR khác so với lúc tạo đơn, có an toàn không?”
  → “Cẩn thận nhé — vui lòng chụp màn hình QR và gửi invoice_id cho mình, mình sẽ kiểm tra xem QR hiện tại có khớp với địa chỉ invoice trên hệ thống không. Nếu không khớp thì không gửi tiền.”
- “Shop có thể hoàn tiền nếu tôi gửi sai mạng không?”
  → “Thông thường refund phải thực hiện trên cùng chain/token. Nếu gửi sai mạng, khả năng lấy lại thấp và phụ thuộc vào từng trường hợp. Vui lòng gửi chi tiết tx (txid, chain) để mình kiểm tra.”
- “Tôi lo bị lừa khi support yêu cầu chuyển tiền”
  → “Đúng là có kẻ giả mạo support. Shop KHÔNG bao giờ yêu cầu seed/private key hoặc yêu cầu bạn chuyển tiền vào ví khác ngoài ví hiển thị trên trang checkout. Nếu ai đó yêu cầu như vậy, báo ngay để shop kiểm tra.”
- “Tôi nghi ngờ gian lận trong đơn hàng của mình”
  → “Xin lỗi vì sự bất tiện — vui lòng cung cấp invoice_id hoặc txid, mình sẽ kiểm tra trên hệ thống và on-chain ngay.”

========================================================================
10. Checklist vận hành & kiểm thử (Ops & Dev)
Deployment checklist:
- [ ] Node(s) cho các chain chính hoạt động và sync.
- [ ] Webhook handler bảo mật (signature + timestamp) và lưu raw payload.
- [ ] HMAC signing cho invoice URLs.
- [ ] WAF & CSP áp dụng cho frontend.
- [ ] Rate limiting cho API create_invoice.
- [ ] Logging & alerting thiết lập cho các sự kiện quan trọng.
- [ ] Quá trình tạo address: address unique cho mỗi invoice (HD wallet).
- [ ] Testnet/sandbox test cover tất cả flow (create, pending, confirm, refund).
- [ ] Review source code for XSS/CSRF vulnerabilities.

Operational checklist (daily/weekly):
- [ ] Review failed/expired invoices.
- [ ] Check new unknown withdrawal addresses.
- [ ] Monitor webhook error rates.
- [ ] Review admin account changes and key rotations.
- [ ] Conduct phishing simulation & staff training quarterly.

========================================================================
11. Công cụ & nguồn tham khảo (gợi ý)
- Run full nodes (Bitcoin Core, geth, OpenEthereum, trond) hoặc reliable provider (Alchemy, Infura, QuickNode).
- Blockchain watchers / notifications (Blocknative, Alchemy Notify).
- Hardware wallets: Ledger, Trezor.
- Multi-sig services: Gnosis Safe (for Ethereum).
- Secrets management: HashiCorp Vault, AWS KMS, Azure Key Vault.

========================================================================
12. Lời khuyên cuối & khuyến nghị cho merchant
- Luôn whitelist token/coin nhận; sử dụng HD wallet tạo address mới cho mỗi invoice; áp dụng multi-sig cho cold wallet; triển khai monitoring on-chain real-time; có playbook incident response rõ ràng; đào tạo nhân viên support để nhận diện social engineering.
- Đối với khách hàng: hướng dẫn luôn kiểm tra domain, chỉ quét QR từ trang HTTPS chính thức, không chia sẻ seed/private key, dùng hardware wallet nếu lưu trữ lớn.

========================================================================
13. Kịch bản mẫu (Case studies ngắn)
- Case A — Invoice hijack: phát hiện mismatch giữa address hiển thị và address invoice => tắt thanh toán, restore page từ bản sao sạch, kiểm tra XSS vector, thông báo khách.
- Case B — Fake txid: khách gửi screenshot tx nhưng tx không tồn tại => từ chối xử lý, yêu cầu txid hợp lệ hoặc hướng dẫn khách gửi lại.

========================================================================
14. Canned responses bổ sung (dùng cho chatbot)
- “Shop có an toàn không? Tôi nên cất seed thế nào?”
  → “Seed phrase KHÔNG lưu online. Viết ra giấy, cất két, hoặc dùng hardware wallet. Nếu muốn, shop có thể gửi checklist lưu seed an toàn.”
- “Tôi thấy invoice expired”
  → “Invoice có expiry để bảo vệ mức giá. Bạn có thể tạo lại invoice mới ở trang thanh toán, mình hỗ trợ nếu cần.”

========================================================================
Kết luận:
File này có thể được dùng trực tiếp làm tài liệu KB cho chatbot, policy nội bộ, hoặc SOP. Nếu bạn muốn, mình sẽ:
- Xuất file này thành **02_wallet_security.txt** trong repository, hoặc
- Chia nhỏ thành các file JSON/YAML cho loader KB (ví dụ: `02_wallet_security_meta.json` + `02_wallet_security_canned_responses.json`), hoặc
- Viết đoạn code webhook handler mẫu (PHP/Node) kèm kiểm tra signature và verify on-chain.

Phiên bản: v1.1 — mở rộng (chi tiết phòng chống gian lận & playbook).
